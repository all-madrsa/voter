<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF Voter Extract Tool</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>

<style>
    body {
        font-family: Arial;
        background: #f1f1f1;
        padding: 20px;
        text-align: center;
    }
    .box {
        background: white;
        padding: 20px;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        margin: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .btn {
        padding: 14px 30px;
        margin: 10px;
        background: #007bff;
        color: white;
        font-size: 18px;
        border-radius: 10px;
        border: none;
    }
    .card {
        width: 100%;
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        text-align: left;
        font-size: 17px;
        line-height: 1.6;
        border: 1px solid #ccc;
    }

    @media print {
        body * { visibility: hidden; }
        #printArea, #printArea * { visibility: visible; }
        #printArea {
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            width: 100%;
        }
        @page { margin: 5mm; }
    }
</style>

</head>
<body>

<h2>Extract Voter Details from PDF</h2>

<div class="box">
    <input type="file" id="pdfFile" accept="application/pdf"><br><br>
    <button class="btn" onclick="extractText()">Extract Info</button>
</div>

<div id="printArea"></div>

<button id="printBtn" class="btn" style="display:none;" onclick="window.print()">Print</button>
<button id="waBtn" class="btn" style="display:none;" onclick="sendWA()">WhatsApp Send</button>

<script>
async function extractText() {
    const file = document.getElementById("pdfFile").files[0];
    if (!file) return alert("Upload PDF!");

    const reader = new FileReader();

    reader.onload = async function () {
        const typedarray = new Uint8Array(this.result);

        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        const page = await pdf.getPage(1);

        const textContent = await page.getTextContent();
        let text = textContent.items.map(item => item.str).join(" ");

        // CLEAN TEXT
        text = text.replace(/\s+/g, " ");

        // AUTO EXTRACT FIELDS
        const data = {
            name: find(text, /(Name|नाम)[^:]*:\s*([A-Za-z\u0900-\u097F ]+)/),
            epic: find(text, /(EPIC|EPIC No|ईपीआईसी)[^:]*:\s*([A-Z0-9]+)/),
            age: find(text, /(Age|आयु)[^:]*:\s*([0-9]+)/),
            gender: find(text, /(Gender|लिंग)[^:]*:\s*([A-Za-z\u0900-\u097F]+)/),
            father: find(text, /(Father|Husband|पति|पिता)[^:]*:\s*([A-Za-z\u0900-\u097F ]+)/),
            house: find(text, /(House|घर)[^:]*:\s*([A-Za-z0-9-]+)/),
            serial: find(text, /(Serial|क्रमांक)[^:]*:\s*([0-9]+)/),
            polling: find(text, /(Polling|Booth|मतदान केंद्र)[^:]*:\s*([A-Za-z\u0900-\u097F 0-9,.-]+)/)
        };

        // MAKE CARD
        let card = `
        <div class="card">
            <b>Name:</b> ${data.name}<br>
            <b>EPIC:</b> ${data.epic}<br>
            <b>Father/Husband:</b> ${data.father}<br>
            <b>Age:</b> ${data.age}<br>
            <b>Gender:</b> ${data.gender}<br>
            <b>House No:</b> ${data.house}<br>
            <b>Serial No:</b> ${data.serial}<br><br>
            <b>Polling Address:</b><br> ${data.polling}
        </div>
        `;

        document.getElementById("printArea").innerHTML = card;
        document.getElementById("printBtn").style.display = "inline-block";
        document.getElementById("waBtn").style.display = "inline-block";
    };

    reader.readAsArrayBuffer(file);
}

// REGEX Extract Helper
function find(text, regex) {
    const match = text.match(regex);
    return match ? match[2] : "Not Found";
}

// WhatsApp Send
function sendWA() {
    const card = document.getElementById("printArea").innerText;
    window.open("https://wa.me/?text=" + encodeURIComponent(card), "_blank");
}
</script>

</body>
</html>
