<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF + Image Mini Printer</title>
<link rel="stylesheet" href="style.css">
<style>
body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; }
input, button { margin: 10px; padding: 10px; }
#imagesList img { max-width:150px; max-height:150px; border-radius:10px; margin-top:10px; }
.btn3d { padding: 15px 50px; font-size: 16px; border-radius: 12px; color: #fff; cursor: pointer; border: none; background: linear-gradient(145deg,#3498db,#2980b9); box-shadow: 0 5px 0 #1c5980,0 8px 15px rgba(0,0,0,0.4);}
.btn3d:active { transform: translateY(5px); box-shadow: 0 2px 0 #1c5980,0 4px 8px rgba(0,0,0,0.4);}
#imagesList {display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
.img-box {position:relative;}
.delete-btn {position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer;}
</style>
</head>
<body>

<h2>PDF + Image Mini Printer Tool</h2>

<label>Select PDF File:</label>
<input type="file" id="pdfFile" accept="application/pdf">

<label>Select Image File (Save Once):</label>
<input type="file" id="imgFile" accept="image/*">

<div id="imagesList"></div>

<button class="btn3d" onclick="mergeAndPrint()">Print</button>
<button class="btn3d" onclick="downloadMerged()">Download</button>
<button class="btn3d" onclick="sendWhatsApp()">WhatsApp Send</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const { jsPDF } = window.jspdf;
let pdfCanvasImg = null;
let imgData = null;

// Load saved image from localStorage
const savedImage = localStorage.getItem('voterImage');
if(savedImage){
    imgData = savedImage;
    displayImage(imgData);
}

// Display uploaded image
function displayImage(src){
    const div = document.getElementById('imagesList');
    div.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'img-box';
    const img = document.createElement('img');
    img.src = src;
    img.style.width='150px';
    img.style.height='150px';
    img.style.objectFit='cover';
    const del = document.createElement('button');
    del.innerText='X';
    del.className='delete-btn';
    del.onclick = () => { localStorage.removeItem('voterImage'); imgData=null; div.innerHTML=''; };
    box.appendChild(img);
    box.appendChild(del);
    div.appendChild(box);
}

// PDF Upload and render to image
document.getElementById('pdfFile').addEventListener('change', async function(){
    const file = this.files[0];
    if(!file) return;
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    const page = await pdf.getPage(1); // first page only (for mini printer)
    const viewport = page.getViewport({ scale: 2 }); 
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const context = canvas.getContext('2d');

    await page.render({canvasContext: context, viewport: viewport}).promise;

    pdfCanvasImg = canvas.toDataURL('image/jpeg');
    alert("PDF processed successfully!");
});

// Image upload (save to localStorage)
document.getElementById('imgFile').addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
        imgData = e.target.result;
        localStorage.setItem('voterImage', imgData);
        displayImage(imgData);
    };
    reader.readAsDataURL(file);
});

// Merge PDF + Image and Print
async function mergeAndPrint(){
    if(!pdfCanvasImg){ alert("Upload PDF first"); return;}
    const doc = new jsPDF({unit:'mm', format:[50,200]}); // 2 inch width
    let y = 0;
    doc.addImage(pdfCanvasImg,'JPEG',0,y,50,100); // adjust height if needed
    y += 105;
    if(imgData){
        const img = new Image();
        img.src = imgData;
        await new Promise(r=>img.onload=r);
        doc.addImage(imgData,'JPEG',0,y,50,50);
    }
    doc.autoPrint();
    window.open(doc.output('bloburl'),'_blank');
}

// Download merged PDF+Image
async function downloadMerged(){
    if(!pdfCanvasImg){ alert("Upload PDF first"); return;}
    const doc = new jsPDF({unit:'mm', format:[50,200]});
    let y = 0;
    doc.addImage(pdfCanvasImg,'JPEG',0,y,50,100);
    y += 105;
    if(imgData){
        const img = new Image();
        img.src = imgData;
        await new Promise(r=>img.onload=r);
        doc.addImage(imgData,'JPEG',0,y,50,50);
    }
    doc.save('VoterMerged.pdf');
}

// WhatsApp send
async function sendWhatsApp(){
    if(!pdfCanvasImg){ alert("Upload PDF first"); return;}
    const doc = new jsPDF({unit:'mm', format:[50,200]});
    let y = 0;
    doc.addImage(pdfCanvasImg,'JPEG',0,y,50,100);
    y += 105;
    if(imgData){
        const img = new Image();
        img.src = imgData;
        await new Promise(r=>img.onload=r);
        doc.addImage(imgData,'JPEG',0,y,50,50);
    }
    const blob = doc.output('blob');
    const file = new File([blob],'VoterMerged.pdf',{type:'application/pdf'});
    const url = URL.createObjectURL(file);
    window.open(`https://wa.me/?text=Voter PDF & Image: ${url}`,'_blank');
}
</script>
</body>
</html>
