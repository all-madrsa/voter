<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF + Image Merge & Print</title>
<style>
body { font-family: Arial; background: #f1f1f1; padding: 20px; }
h2 { text-align: center; margin-bottom: 20px; }
input { margin: 10px 0; display:block; }
#preview { margin-top: 20px; border:1px solid #ccc; padding:10px; background:#fff; }
img.preview-img { width:150px; height:150px; object-fit:cover; display:block; margin:10px auto; }
button { margin: 10px; padding:10px 20px; font-size:16px; cursor:pointer; }
#pdfData { margin-top:10px; font-size:14px; line-height:1.4; white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PDF + Image Merge Tool</h2>

<label>Select PDF File:</label>
<input type="file" id="pdfFile" accept=".pdf">

<label>Select Image File:</label>
<input type="file" id="imageFile" accept="image/*">

<button id="mergeBtn">Merge PDF + Image</button>

<div id="preview">
    <canvas id="pdfCanvas" style="display:none;"></canvas>
    <img id="imgPreview" class="preview-img">
    <div id="pdfData"></div>
    <button id="printBtn">Print</button>
    <button id="downloadBtn">Download</button>
    <button id="whatsappBtn">WhatsApp Send</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let pdfFile, imageFile, extractedData;

// Load PDF
document.getElementById('pdfFile').addEventListener('change', e => {
    pdfFile = e.target.files[0];
});

// Load Image
document.getElementById('imageFile').addEventListener('change', e => {
    imageFile = e.target.files[0];
    const imgPreview = document.getElementById('imgPreview');
    imgPreview.src = URL.createObjectURL(imageFile);
});

// Merge PDF + Image
document.getElementById('mergeBtn').addEventListener('click', async () => {
    if(!pdfFile){ alert("Please select a PDF"); return; }

    // Extract PDF text
    const pdfData = await extractPDFText(pdfFile);
    extractedData = extractFields(pdfData);
    document.getElementById('pdfData').textContent = formatData(extractedData);
});

// Print
document.getElementById('printBtn').addEventListener('click', () => {
    if(!extractedData) return alert("Merge PDF + Image first");
    const doc = new jspdf.jsPDF({
        unit:'mm',
        format:[50,200] // 2 inch width, height flexible
    });

    let y = 5;
    for(const key in extractedData){
        if(extractedData[key]) {
            doc.text(`${key}: ${extractedData[key]}`,5,y);
            y += 5;
        }
    }

    if(imageFile){
        const img = document.getElementById('imgPreview');
        doc.addImage(img, 'JPEG',5,y,40,40); // width 40mm height 40mm
    }

    doc.autoPrint();
    window.open(doc.output('bloburl'), '_blank');
});

// Download
document.getElementById('downloadBtn').addEventListener('click', () => {
    if(!extractedData) return alert("Merge PDF + Image first");
    const doc = new jspdf.jsPDF({unit:'mm', format:[50,200]});
    let y = 5;
    for(const key in extractedData){
        if(extractedData[key]) {
            doc.text(`${key}: ${extractedData[key]}`,5,y);
            y += 5;
        }
    }
    if(imageFile){
        const img = document.getElementById('imgPreview');
        doc.addImage(img, 'JPEG',5,y,40,40);
    }
    doc.save('voter_merge.pdf');
});

// WhatsApp send
document.getElementById('whatsappBtn').addEventListener('click', () => {
    if(!extractedData) return alert("Merge PDF + Image first");
    alert("For WhatsApp send, please download PDF first and send manually (WhatsApp Web or App).");
});

// ---------------- Helper Functions ----------------
async function extractPDFText(file){
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
    let textContent = '';
    for(let i=0;i<pdf.numPages;i++){
        const page = await pdf.getPage(i+1);
        const txt = await page.getTextContent();
        textContent += txt.items.map(t=>t.str).join(' ') + '\n';
    }
    return textContent;
}

function extractFields(text){
    function getField(text,label){
        const regex = new RegExp(label + '\\s*:?\\s*(.*?)\\s*(?=\\n|$)','i');
        const match = text.match(regex);
        return match? match[1].trim() : '';
    }

    return {
        'First Name': getField(text,'पहिले नाव / First Name'),
        'Last Name': getField(text,'आडनाव / Last Name'),
        "Relative First": getField(text,"नातेवाईकाचे पहिले नाव / Relative's First Name"),
        "Relative Last": getField(text,"नातेवाईकाचे आडनाव / Relative's Last Name"),
        'Age': getField(text,'वय / Age'),
        'Gender': getField(text,'लिंग / Gender'),
        'EPIC No': getField(text,'EPIC क्रमांक / EPIC No'),
        'State': getField(text,'राज्य / State'),
        'Parliamentary Constituency': getField(text,'संसदीय मतदारसंघ क्रमांक- संसदीय मतदारसंघाचे नाव / Parliamentary Constituency Number - Parliamentary Constituency Name'),
        'Assembly Constituency': getField(text,'विधानसभा मतदारसंघ क्रमांक- विधानसभा मतदारसंघाचे Name / Assembly Constituency Number-Assembly Constituency Name'),
        'Polling Station': getField(text,'मतदान केंद्र / Polling Station'),
        'Part Number': getField(text,'भाग क्रमांक-भागाचे नाव / Part Number- Part Name'),
        'Part Serial': getField(text,'भाग अनुक्रम क्रमांक/ Part Serial Number'),
        'Polling Date': getField(text,'मतदानाची तारीख / Polling Date')
    };
}

function formatData(data){
    return Object.entries(data).map(([k,v])=>`${k}: ${v}`).join('\n');
}
</script>
</body>
</html>
