<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Slip Extract & PDF</title>
<style>
body {font-family: Arial,sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px;}
input, button {margin:5px; padding:8px; font-size:14px;}
#preview {border:1px solid #ccc; padding:10px; margin-top:20px; width:320px;}
.slip-row {margin-bottom:5px; font-size:14px;}
.slip-label {font-weight:bold; display:inline-block; width:120px;}
#voterImg {width:80px; height:80px; object-fit:cover; margin-top:10px;}
.btn3d {padding:8px 15px; font-size:12px; border-radius:8px; color:#fff; cursor:pointer; border:none; background:linear-gradient(145deg,#3498db,#2980b9); box-shadow:0 3px 0 #1c5980,0 4px 8px rgba(0,0,0,0.4);}
.btn3d:active {transform:translateY(3px); box-shadow:0 1px 0 #1c5980,0 2px 4px rgba(0,0,0,0.4);}
</style>
</head>
<body>

<h2>Voter Slip Extract</h2>

<label>Select PDF File:</label>
<input type="file" id="pdfFile" accept="application/pdf"><br>
<label>Select Voter Image:</label>
<input type="file" id="imgFile" accept="image/*"><br>

<button class="btn3d" onclick="mergePreview()">Preview</button>
<button class="btn3d" onclick="downloadPDF()">Download PDF</button>

<div id="preview"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let voterImg = null;
let extracted = {};

// Load voter image and save in localStorage
document.getElementById('imgFile').addEventListener('change', function(){
    const reader = new FileReader();
    reader.onload = e => {
        voterImg = e.target.result;
        localStorage.setItem('voterImage', voterImg);
    };
    reader.readAsDataURL(this.files[0]);
});

// Extract text from PDF
document.getElementById('pdfFile').addEventListener('change', async function(){
    const file = this.files[0];
    if(!file) return;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    let fullText = '';
    for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + ' ';
    }

    // Extract only required fields using regex
    function getField(regex){
        const match = fullText.match(regex);
        return match ? match[1].trim() : '';
    }

    extracted = {
        firstName: getField(/First Name\s*[:\-]?\s*([A-Za-z\s]+)/i),
        lastName: getField(/Last Name\s*[:\-]?\s*([A-Za-z\s]+)/i),
        epic: getField(/Epic no\.?\s*[:\-]?\s*(\S+)/i),
        serial: getField(/Serial No\.?\s*[:\-]?\s*(\S+)/i),
        partNo: getField(/Part No\.?\s*[:\-]?\s*(\S+)/i),
        polling: getField(/Polling Station Address\s*[:\-]?\s*(.+)/i)
    };

    alert('PDF text extracted successfully!');
});

// Preview extracted data + voter image
function mergePreview(){
    const div = document.getElementById('preview');
    div.innerHTML = '';
    if(!extracted.epic){ alert('Upload PDF first!'); return; }

    for(const key in extracted){
        const row = document.createElement('div');
        row.className = 'slip-row';
        row.innerHTML = `<span class="slip-label">${key.replace(/([A-Z])/g,' $1').trim()}:</span> ${extracted[key]}`;
        div.appendChild(row);
    }

    const savedImg = localStorage.getItem('voterImage');
    if(savedImg){
        const img = document.createElement('img');
        img.src = savedImg;
        img.id = 'voterImg';
        div.appendChild(img);
    }
}

// Download A6 PDF with extracted info + voter image
async function downloadPDF(){
    if(!extracted.epic){ alert('Upload PDF first!'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a6'});
    let y = 10;

    for(const key in extracted){
        doc.text(`${key.replace(/([A-Z])/g,' $1').trim()}: ${extracted[key]}`, 10, y);
        y += 10;
    }

    const savedImg = localStorage.getItem('voterImage');
    if(savedImg){
        doc.addImage(savedImg, 'JPEG', 10, y, 40, 40);
    }

    doc.save('voter-slip.pdf');
}
</script>
</body>
</html>
