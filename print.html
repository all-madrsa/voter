<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Slip Extract & PDF</title>
<style>
body {font-family: Arial,sans-serif; display:flex; flex-direction:column; align-items:center; padding:10px;}
input, button {margin:5px; padding:8px; font-size:14px;}
#preview {border:1px solid #ccc; padding:10px; margin-top:20px; width:350px;}
.slip-row {margin-bottom:5px; font-size:14px;}
#voterImg {width:80px; height:80px; object-fit:cover; margin-top:10px;}
.btn3d {padding:8px 15px; font-size:12px; border-radius:8px; color:#fff; cursor:pointer; border:none; background:linear-gradient(145deg,#3498db,#2980b9); box-shadow:0 3px 0 #1c5980,0 4px 8px rgba(0,0,0,0.4);}
.btn3d:active {transform:translateY(3px); box-shadow:0 1px 0 #1c5980,0 2px 4px rgba(0,0,0,0.4);}
</style>
</head>
<body>

<h2>Voter Slip Extract</h2>

<label>Select PDF File:</label>
<input type="file" id="pdfFile" accept="application/pdf"><br>
<label>Select Voter Image:</label>
<input type="file" id="imgFile" accept="image/*"><br>

<button class="btn3d" onclick="mergePreview()">Preview / Merge</button>
<button class="btn3d" onclick="deleteImage()">Delete Image</button>
<button class="btn3d" onclick="downloadPDF()">Download PDF</button>

<div id="preview"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let voterImg = null;
let extracted = {};

// Load voter image
document.getElementById('imgFile').addEventListener('change', function(){
    const reader = new FileReader();
    reader.onload = e => {
        voterImg = e.target.result;
        localStorage.setItem('voterImage', voterImg);
    };
    reader.readAsDataURL(this.files[0]);
});

// Delete saved image
function deleteImage(){
    voterImg = null;
    localStorage.removeItem('voterImage');
    alert('Image deleted!');
    mergePreview();
}

// Extract text from PDF
document.getElementById('pdfFile').addEventListener('change', async function(){
    const file = this.files[0];
    if(!file) return;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    let fullText = '';
    for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join('\n') + '\n';
    }

    const lines = fullText.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    extracted = {}; // reset

    lines.forEach(line=>{
        if(line.includes('Name:') && !extracted.firstName){
            const name = line.split(':')[1].trim();
            const parts = name.split(' ');
            extracted.firstName = parts[0] || '';
            extracted.lastName = parts.slice(1).join(' ') || '';
        }
        else if(line.includes("Husband's Name:")){
            extracted.husbandName = line.split(':')[1].trim();
        }
        else if(line.includes('Date of Birth') || line.includes('DOB')){
            extracted.dob = line.split(':')[1].trim();
        }
        else if(line.includes('Epic no.') || line.includes('EPIC No')){
            extracted.epic = line.split(':')[1].trim();
        }
        else if(line.includes('Serial No.')){
            extracted.serial = line.split(':')[1].trim();
        }
        else if(line.includes('Part No.') ){
            extracted.partNo = line.split(':')[1].trim();
        }
        else if(line.includes('Assembly Constituency') ){
            extracted.constituency = line.split(':')[1].trim();
        }
        else if(line.includes('Polling Station') ){
            extracted.polling = line.split(':')[1].trim();
        }
    });

    alert('PDF text extracted successfully!');
});

// Preview extracted data
function mergePreview(){
    const div = document.getElementById('preview');
    div.innerHTML = '';
    for(const key in extracted){
        if(extracted[key]){
            const row = document.createElement('div');
            row.className = 'slip-row';
            row.innerHTML = `${key}: ${extracted[key]}`;
            div.appendChild(row);
        }
    }
    const savedImg = localStorage.getItem('voterImage');
    if(savedImg){
        const img = document.createElement('img');
        img.src = savedImg;
        img.id = 'voterImg';
        div.appendChild(img);
    }
}

// Download PDF
async function downloadPDF(){
    if(!Object.keys(extracted).length){ 
        alert('Upload PDF first!'); 
        return; 
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a6'});
    let y = 10;

    for(const key in extracted){
        if(extracted[key]){
            let text = extracted[key].replace(/\u2018|\u2019/g,"'").replace(/\u201c|\u201d/g,'"');
            doc.text(`${key}: ${text}`, 10, y);
            y += 10;
        }
    }

    const savedImg = localStorage.getItem('voterImage');
    if(savedImg){
        await new Promise((resolve)=>{
            const img = new Image();
            img.src = savedImg;
            img.onload = ()=>{
                doc.addImage(img, 'JPEG', 10, y, 40, 40);
                resolve();
            }
        });
    }

    doc.save('voter-slip.pdf');
}
</script>
</body>
</html>
